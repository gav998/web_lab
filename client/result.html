<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Форма тестирования</title>
    <link href="./bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <script src="./bootstrap.bundle.min.js"></script>
	<script src="./conf.js"></script>
	
	<div class="container">
	  <div class="row border-bottom border-primary py-3">
		<div class="col d-grid gap-2 mx-auto">			
		  <a id="HREF" class="btn btn-outline-primary" href=""></a>	
		  <a id="HOME" class="btn btn-outline-success" href="./">Перейти к списку тестов</a>
		  <a id="TOTEST" class="btn btn-outline-success" href="./">Вернуться к заданиям</a>		  
		</div>
	  </div>
	</div>		
	
	<div class="container">
	  <div class="row border-bottom border-primary py-3">
		<div class="col d-grid gap-2 d-md-block">
		  <button class="btn border-0" id="TEST"></button>
		  <button class="btn border-0" id="NAME"></button>
		  <button class="btn border-0" id="NUM"></button>
		  <button class="btn border-0" id="LETTER"></button>
		  <button class="btn border-0" id="TIME_START"></button>
		  <button class="btn border-0" id="PROCENT"></button>		  
		</div>
	  </div>
	</div>	
	
	
	<div class="container">
	  <div class="row py-3">
		<div class="col">
		
			<table class="table">
			  <thead>
				<tr>
				  <th scope="col">#</th>
				  <th scope="col">Ваш ответ</th>
				  <th scope="col">Правильный ответ</th>
				</tr>
			  </thead>
			  <tbody id="RES_TABLE">

			  </tbody>
			</table>	
		
		</div>
	  </div>
	</div>


			<script>
				console.log("Начало работы");
				
				function read_get_values() {
					console.log("Чтение GET параметров");
					var p_url=location.search.substring(1);
					var parametr=p_url.split("&");				
					var values= new Array();
					for(let i=0; i < parametr.length; i++){
						j=parametr[i].split("="); 
						values[j[0]]=unescape(j[1]);
					}
					console.log(values);
					return values
				}
				var values = read_get_values();
				var UUID = values["UUID"];

			</script>
			
			<script>
				console.log("Инициализация API функции получения инфо и текста задания get_test() используя UUID, task по адр get_test");	

				async function get_full_test_and_lock() {
					console.log("get_full_test_and_lock()");
					let url = new URL(server + "get_full_test_and_lock/");
					url.searchParams.set('UUID', UUID);				
					let response = await fetch(url);
					if (response.ok) { // если HTTP-статус в диапазоне 200-299
					  // получаем тело ответа
					  let json = await response.json();
					  console.log(json);
					  console.log("Добавляем на страницу инфо о тесте");
						document.getElementById('HREF').innerHTML = location.href;	
						document.getElementById('HREF').href = location.href;
						
						document.getElementById('TEST').innerHTML = json['TEST'];
						document.getElementById('NAME').innerHTML = json['NAME'];
						document.getElementById('NUM').innerHTML = json['NUM'];
						document.getElementById('LETTER').innerHTML = json['LETTER'];
						document.getElementById('TIME_START').innerHTML = (json['TIME_START'] != null) ? json['TIME_START'].slice(0, 19) : "";
						var count = json['COUNT'];
						let count_success = 0;
						
						var msg = ""
						for (let i = 1; i <= count; i++){
							if (json['T_'+i+'_ANSW'] == json['T_'+i+'_ANSW_CORRECT']){
								msg = msg + '<tr class="table-success">';
								count_success = count_success + 1;
							}else{
								msg = msg + '<tr class="table-danger">';
							}
							msg = msg + '<th scope="row">'+i+'</th>';
							msg = msg + '<td >'+json['T_'+i+'_ANSW']+'</td>';
							msg = msg + '<td >'+json['T_'+i+'_ANSW_CORRECT']+'</td>';
						}
						document.getElementById('RES_TABLE').innerHTML = msg;
						document.getElementById('PROCENT').innerHTML = String(count_success/count*100).slice(0, 2)+"%";
					} else {
					  alert("Ошибка HTTP: " + response.status);
					}
				}
				
				get_full_test_and_lock();
			</script>			
			

  </body>
</html>